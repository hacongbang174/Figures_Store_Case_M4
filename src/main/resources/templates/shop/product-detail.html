<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Admin Dashboard Figure</title>
    <th:block th:replace="/layout/head :: head"></th:block>
    <link rel="stylesheet" href="/assets/bootstrap/v5.3.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="/assets/css/styles.css">
    <style>
        .content {
            padding: 10px;
        }
        .product-carts {
            display: flex;
            flex-wrap: wrap;
            float: left;
            margin-left: 0;
            margin-right: 0;
            padding-left: 100px;
        }
        .product-price-unit {
            display: flex;
            justify-content: space-between;
            margin-left: 0;
            margin-right: 0;
        }
        /*.product-price {*/
        /*    color: #ff6600;*/
        /*    font-weight: bold;*/
        /*}*/
        .product-cart {
            margin: 5px;
            padding: 0;
            float: left;
        }
        .card-footer {
            margin: 0;
            padding: 0;
            border: none;
        }
        .btnAddCart {
            width: 100%;
        }
        .payment {
            float: right;
            padding-right: 70px;
        }
        .invalid {
            border: 1px solid red;
        }
        .payment .payment_defult{
            margin-top: 20px;
        }
        .product-detail {
            border: none;
        }
        .quantity-input {
            margin: 0;
            width: 50px;
        }
        .changeQuantity {
            border: none;
            background-color: #fff;
            padding: 0;
        }
        .product_price {
            padding: 10px;
        }
        .current_price-format {
            color: red;
            font-weight: bolder;
        }
        .product-quantity {
            width: 70px;
        }
    </style>
</head>

<body>
<div id="wrapper">
    <th:block th:replace="/layout/topbar :: topbar"></th:block>
    <th:block th:replace="/layout/left-sidebar :: left-sidebar"></th:block>

    <div class="content-page">
        <div class="content">
            <div class="container-fluid">
                <div class="table-title">
                    <div class="row">
                        <div class="col-sm-4">
                            <h1>Figure Detail</h1>
                        </div>
                        <div class="col-sm-8">
                            <button type="button" class="btn btn-outline-light modal-cart" id="create">
                                <i class="fa-solid fa-cart-shopping">
                                </i>
                                <span class="cart-count" id="count-cart">0</span>
                                Sản phẩm
                            </button>
                        </div>
                    </div>
                </div>

                <th:block th:replace="/shop/modal-cart :: modal-cart"></th:block>

                <div class="row">

                    <div class="col-lg-5 col-md-5">
                        <div class="product-details-tab">

                            <div id="img-1" class="zoomWrapper single-zoom">
                                <a href="#">
                                    <img id="zoom1" th:src="${product.avatar.getFileUrl()}" th:data-zoom-image="${product.avatar.getFileUrl()}"
                                         alt="product">
                                </a>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-7 col-md-7">
                        <div class="product_d_right">
                            <form method="post">
                                <h1 th:text="${product.getTitle()}"></h1>
                                <div class="product_price">
                                    <input class="current_price" th:value="${product.getPrice()}" hidden="true">
                                    <span class="current_price-format"></span>
                                </div>
                                <div class="product_variant quantity">
                                    <label>Quantity : </label>
                                    <input min="1" class="product-quantity" max="${ProductData.getQuantity()}" name="quantity" type="number" value="1" style="text-align: center">

                                </div>
                                <div class="product_desc">
                                    <p th:text="${product.getDescription()}"></p>
                                </div>
                                <input class="product-id" th:value="${product.getId()}" hidden="true">
                                <button type="button" class="btn btn-outline-primary btn-addCart">Thêm vào giỏ hàng</button>

                            </form>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
    <th:block th:replace="/layout/footer :: footer"></th:block>
</div>

<th:block th:replace="/layout/script :: script"></th:block>
<script src="/assets/jquery/jquery-3.7.0.min.js"></script>
<script src="/assets/jquery/jquery.validate.js"></script>
<script src="/assets/bootstrap/v5.3.0/js/bootstrap.bundle.min.js"></script>
<script src="/assets/sweetalert2/sweetalert2.all.min.js"></script>
<script src="/assets/js/magnific-popup-1.1.0.js"></script>

<script src="/assets/js/appBase.js"></script>

<script>
    const page = {
        urls: {
            getAllCategories: AppBase.API_CATEGORY,
            getAllProducts: AppBase.API_PRODUCT,
            getAllCartDetails: AppBase.API_CART_DETAIL,
            getAddToCart : AppBase.API_ADD_TO_CART,
            getPayment: AppBase.API_PAYMENT,
            getDelete: AppBase.API_DELETED_CART_ITEM,
            getChangeQuantity: AppBase.API_CHANGE_QUANTITY
        },
        elements: {},
        commands: {},
        dialogs: {
            elements: {},
            commands: {}
        },
    }

    page.elements.productCarts = $('#product-carts')

    page.dialogs.elements.tbCart = $('#tbCart tbody')
    page.dialogs.elements.modalCart = $('#mdCart')
    page.dialogs.elements.totalAmount = $('#totalAmount')

    page.dialogs.elements.btnAddCart = $('.btnAddCart')
    page.elements.countCart = $('#count-cart')

    page.dialogs.elements.payment = $('.payment-cart')
    page.dialogs.elements.cancelPayment = $('.cancel-cart')

    page.dialogs.elements.paymentDefult = $('#payment_defult')
    page.dialogs.elements.frmPayment = $('#frmPayment')
    page.dialogs.elements.changeQuantity = $('.changeQuantity')

    page.commands.getAllCartDetail = () => {
        $.ajax({
            type: 'GET',
            url: page.urls.getAllCartDetails
        })
            .done((data) => {
                let totalAmount = 0;
                let count = 0;
                $.each(data, (index, item) => {
                    const str = page.commands.renderCart(item);
                    totalAmount = totalAmount + item.amount;
                    page.dialogs.elements.tbCart.prepend(str)
                    count = count + item.quantity
                })
                page.elements.countCart.text(count)
                page.dialogs.elements.totalAmount.text(totalAmount.toLocaleString('vi', {style : 'currency', currency : 'VND'}));
                page.commands.deleteProduct();
                page.commands.changeQuantity();
            })
            .fail((jqXHR) => {
                console.log(jqXHR)
            })
    }

    page.commands.renderCart = (obj) => {
        const imageUrl = AppBase.BASE_URL_CLOUD_IMAGE + '/' + AppBase.IMAGE_SCALE_W_280_h_180_Q_100 + '/' + obj.productDTO.avatar.fileFolder + '/' + obj.productDTO.avatar.fileName;
        const price = obj.price.toLocaleString('vi', {style : 'currency', currency : 'VND'});
        const amount = obj.amount.toLocaleString('vi', {style : 'currency', currency : 'VND'});
        return `
                <tr id="tr_${obj.id}">
                    <td>
                        <span class="product-id">${obj.id}</span>
                    </td>
                    <td>${obj.title}</td>
                    <td>
                         <img src="${imageUrl}" class="card-img-top" alt="...">
                    </td>
                    <td>${obj.unit}</td>
                    <td>
                        <span class="price-obj" hidden="true">${obj.price}</span>
                        <span class="price">${price}</span>
                    </td>
                    <td>
                        <button type="button" class="changeQuantity" data-id="${obj.id}">
                            <input class="quantity-input" name="quantity" min="1" max="100" value="${obj.quantity}" type="number">
                        </button>
                    </td>
                    <td>
                        <span class="amount">${amount}</span>
                    </td>
                    <td>
                        <a class="btn btn-outline-danger delete" data-id="${obj.id}" >
                            <i class="far fa-trash-alt"></i>
                        </a>
                    </td>
                </tr>
            `;
    }

    page.commands.getProductById = (productId) => {
        return $.ajax({
            type: 'GET',
            url: page.url.getAllProduct + '/' + productId
        });
    }


    page.commands.showCart = () => {
        $('.modal-cart').on('click', () => {
            page.dialogs.elements.modalCart.addClass('show');
            page.dialogs.elements.modalCart.modal('show')
        })
    }

    page.commands.doAddToCart = () => {
        $('.btnAddCart').on('click', function () {
            let productId = $(this).data('id');
            let cartItem = {
                productId : productId,
                quantity: 1
            }
            $.ajax({
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                type: 'POST',
                url: page.urls.getAddToCart,
                data: JSON.stringify(cartItem)
            })
                .done((data) => {
                    page.dialogs.elements.tbCart.empty();
                    let totalAmount = 0;
                    let count = 0;
                    $.each(data, (index, item) => {
                        const str = page.commands.renderCart(item);
                        totalAmount = totalAmount + item.amount;
                        page.dialogs.elements.tbCart.prepend(str)
                        count = count + item.quantity
                    })
                    page.elements.countCart.text(count)
                    page.dialogs.elements.totalAmount.text(totalAmount.toLocaleString('vi', {style : 'currency', currency : 'VND'}));
                    page.commands.deleteProduct();
                    page.commands.changeQuantity();
                })
                .fail((err) => {
                    console.log(err)
                    AppBase.SweetAlert.showErrorAlert(AppBase.AlertMessageVi.ERROR_404);
                })
        })
    }

    page.commands.deleteProduct = () => {
        $('.delete').on('click', function () {
            let cartDetailId = $(this).data('id')
            Swal.fire({
                title: 'Are you sure?',
                text: "You won't be able to revert this!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085D6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Yes, delete it!'
            }).then((result) => {
                if (result.isConfirmed) {
                    page.dialogs.commands.doDelete(cartDetailId);
                }
            })
        })
    }

    page.dialogs.commands.doDelete = (cartDetailId) => {
        $.ajax({
            type: "DELETE",
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            },
            url: page.urls.getDelete + '/' + cartDetailId,
        }).done((data) => {

            AppBase.SweetAlert.showSuccessAlert(AppBase.AlertMessageEn.SUCCESS_DELETED);

            page.dialogs.elements.tbCart.empty();
            let totalAmount = 0;
            let count = 0;
            $.each(data, (index, item) => {
                const str = page.commands.renderCart(item);
                totalAmount = totalAmount + item.amount;
                page.dialogs.elements.tbCart.prepend(str)
                count = count + item.quantity
            })
            page.elements.countCart.text(count)
            page.dialogs.elements.totalAmount.text(totalAmount.toLocaleString('vi', {style : 'currency', currency : 'VND'}));
            page.commands.deleteProduct();
            page.commands.changeQuantity();

            page.commands.handleImagePopup();

        }).fail(function (jqXHR) {
            AppBase.SweetAlert.showErrorAlert(jqXHR.responseJSON.message);
        })
    }


    page.commands.changeQuantity = () => {
        $('.changeQuantity').on('click', function (){
            let cartDetailId = $(this).data('id');
            let quantity = $(this).find('.quantity-input').val()
            let cartDetail = {
                quantity: quantity
            }
            $.ajax({
                type: "PATCH",
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                url: page.urls.getChangeQuantity + '/' + cartDetailId,
                data: JSON.stringify(cartDetail)
            })
                .done((data) => {
                    page.dialogs.elements.tbCart.empty();
                    let totalAmount = 0;
                    let count = 0;
                    $.each(data, (index, item) => {
                        const str = page.commands.renderCart(item);
                        totalAmount = totalAmount + item.amount;
                        page.dialogs.elements.tbCart.prepend(str)
                        count = count + item.quantity
                    })
                    page.elements.countCart.text(count)
                    page.dialogs.elements.totalAmount.text(totalAmount.toLocaleString('vi', {style : 'currency', currency : 'VND'}));
                    page.commands.deleteProduct();
                    page.commands.changeQuantity();
                })
                .fail((err) => {
                    console.log(err)
                    AppBase.SweetAlert.showErrorAlert(AppBase.AlertMessageVi.ERROR_404);
                })
        })
    }

    page.commands.getPayment = () => {
        let pay =  $(".payment_defult:checked").val();
        console.log(pay)
        let bill = new Bill();
        if(pay === 'momo') {
            bill = {
                status: "DONE"
            }
        }
        if (pay === 'cod') {
            bill = {
                status: "ORDER"
            }
        }
        console.log(bill)
        $.ajax({
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            },
            type: 'POST',
            url: page.urls.getPayment,
            data: JSON.stringify(bill)
        })
            .done((data) => {
                console.log(data)
                AppBase.SweetAlert.showSuccessAlert(AppBase.AlertMessageEn.SUCCESS_PAYMENT);
                page.dialogs.elements.tbCart.empty()
                page.commands.getAllCartDetail();
                page.dialogs.elements.modalCart.removeClass('show');
                page.dialogs.elements.modalCart.modal('hide')
            })
            .fail((jqXHR) => {
                AppBase.SweetAlert.showErrorAlert(AppBase.AlertMessageVi.ERROR_400);
            })
    }

    page.dialogs.elements.frmPayment.validate({
        rules: {
            payment_method: {
                required: true,
            }
        },
        messages: {
            payment_method: {
                required: "Vui lòng chọn phương thức thanh toán.",
            }
        },
        errorLabelContainer: "#mdCart .modal-alert-danger",
        errorPlacement: function (error, element) {
            error.appendTo("#mdCart .modal-alert-danger");
        },
        showErrors: function (errorMap, errorList) {
            if (this.numberOfInvalids() > 0) {
                $("#mdCart .modal-alert-danger").removeClass("hide").addClass("show");
            } else {
                $("#mdCart .modal-alert-danger").removeClass("show").addClass("hide").empty();
                $("#frmPayment input.error").removeClass("error");
            }
            this.defaultShowErrors();
        },
        submitHandler: function () {
            page.commands.getPayment();
        }
    })



    page.loadData = () => {
        page.commands.getAllCartDetail();
        page.commands.doAddToCart();
        page.commands.showCart();
    }

    page.initializeControlEvent = () => {
        page.dialogs.elements.payment.on('click', () => {
            page.dialogs.elements.frmPayment.trigger('submit');
        });
    }

    $(() => {
        page.loadData();

        page.initializeControlEvent();
    })

</script>



</body>
</html>